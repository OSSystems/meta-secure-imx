From a0b996991a9b3c73adcebf2dd86abe6a3cf0291b Mon Sep 17 00:00:00 2001
From: Richard Weinberger <richard@nod.at>
Date: Thu, 4 Apr 2019 12:56:55 +0200
Subject: [PATCH 10/13] ubifs: Fix build for CONFIG_UBIFS_FS_ENCRYPTION=n

Signed-off-by: Richard Weinberger <richard@nod.at>
---
 fs/ubifs/super.c | 10 +++++++++-
 fs/ubifs/ubifs.h |  1 -
 2 files changed, 9 insertions(+), 2 deletions(-)

diff --git a/fs/ubifs/super.c b/fs/ubifs/super.c
index 7192b779bb66..a54fa14f15c2 100644
--- a/fs/ubifs/super.c
+++ b/fs/ubifs/super.c
@@ -2142,7 +2142,9 @@ static int ubifs_fill_super(struct super_block *sb, void *data, int silent)
 	struct ubifs_info *c = sb->s_fs_info;
 	struct inode *root;
 	int err;
-	struct fscrypt_operations *cop;
+#ifdef CONFIG_UBIFS_FS_ENCRYPTION
+	struct fscrypt_operations *cop = NULL;
+#endif
 
 	c->vfs_sb = sb;
 	/* Re-open the UBI device in read-write mode */
@@ -2182,6 +2184,7 @@ static int ubifs_fill_super(struct super_block *sb, void *data, int silent)
 #ifdef CONFIG_UBIFS_FS_XATTR
 	sb->s_xattr = ubifs_xattr_handlers;
 #endif
+#ifdef CONFIG_UBIFS_FS_ENCRYPTION
 	cop = kmemdup(&ubifs_crypt_operations, sizeof ubifs_crypt_operations,
 		     GFP_NOFS);
 	if (!cop) {
@@ -2194,6 +2197,9 @@ static int ubifs_fill_super(struct super_block *sb, void *data, int silent)
 		       goto out_free;
 	}
 	fscrypt_set_ops(sb, cop);
+#else
+	fscrypt_set_ops(sb, &ubifs_crypt_operations);
+#endif
 
 	mutex_lock(&c->umount_mutex);
 	err = mount_ubifs(c);
@@ -2222,8 +2228,10 @@ static int ubifs_fill_super(struct super_block *sb, void *data, int silent)
 	ubifs_umount(c);
 out_unlock:
 	mutex_unlock(&c->umount_mutex);
+#ifdef CONFIG_UBIFS_FS_ENCRYPTION
 out_free:
 	kfree(cop);
+#endif
 out_close:
 	ubi_close_volume(c->ubi);
 out:
diff --git a/fs/ubifs/ubifs.h b/fs/ubifs/ubifs.h
index 3d32e6ea0037..33702a1148b1 100644
--- a/fs/ubifs/ubifs.h
+++ b/fs/ubifs/ubifs.h
@@ -2091,7 +2091,6 @@ static inline int ubifs_decrypt(const struct inode *inode,
 }
 static inline void ubifs_fscrypt_exit(void)
 {
-	ubifs_assert(0);
 }
 #else
 /* crypto.c */
-- 
2.24.1

